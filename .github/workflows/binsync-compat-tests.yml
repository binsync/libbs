# This workflow tests libbs compatibility with binsync
# It ensures that changes to libbs don't break binsync functionality

name: BinSync Compatibility Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  binsync-tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 3.10
      uses: actions/setup-python@v2
      with:
        python-version: "3.10"
    - name: Set branch name
      run: echo "BRANCH_NAME=${GITHUB_HEAD_REF}" >> $GITHUB_ENV
    - name: Install libbs from current branch
      run: |
        python -m pip install --upgrade pip
        pip install .
    - name: Install binsync and run its core tests
      run: |
        # Clone binsync and try to checkout the same branch if it exists
        git clone https://github.com/binsync/binsync.git /tmp/binsync
        cd /tmp/binsync
        git checkout $BRANCH_NAME || true
        pip install pytest .[extras]
        # Run binsync core tests
        pytest ./tests/test_client.py ./tests/test_state.py ./tests/test_auxiliary_server.py -v

  installer-tests:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.10"]

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: "${{ matrix.python-version }}"
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest .
    - name: Test CLI Installer
      run: |
        pytest ./tests/test_cli.py::TestInstaller -v
